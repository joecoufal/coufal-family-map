<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coufal Family Historical Addresses</title>
    <!-- config.js will be loaded first -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        #map {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            min-height: 500px;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
            max-width: 180px;
        }

        .legend h3 {
            margin-bottom: 8px;
            font-size: 14px;
            text-align: center;
        }

        .family-toggle-button {
            border: none;
            margin: 3px 2px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            width: calc(100% - 4px);
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
        }
        
        .family-toggle-button.active {
            opacity: 1;
        }

        .family-toggle-button:not(.active) {
            opacity: 0.7;
        }

        .family-toggle-button .toggle-icon {
            font-size: 16px;
            margin-left: 8px;
        }

        .legend .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            gap: 8px;
        }

        .legend .action-button {
            background-color: #5e6c7a;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 12px;
            text-align: center;
            flex: 1;
        }
        
        .legend .action-button:hover {
            background-color: #4a545e;
        }

        .popup-content {
            padding: 5px;
            max-width: 250px;
        }

        .popup-content h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .popup-content p {
            font-size: 14px;
            margin: 5px 0;
        }

        .popup-content .action-button { 
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            transition: background-color 0.2s;
            text-decoration: none;
            display: block; 
            font-size: 14px;
            text-align: center;
            width: 100%;
        }
        .popup-content .action-button:hover {
             background-color: #34495e;
        }

        @media (max-width: 600px) {
            .legend {
                bottom: 10px;
                right: 10px;
                padding: 8px;
                max-width: 140px;
            }
            .family-toggle-button {
                font-size: 11px;
                padding: 6px;
            }
            .legend .action-button {
                font-size: 11px;
                padding: 6px;
            }
            .popup-content {
                max-width: 200px;
            }
            .popup-content h3 {
                font-size: 14px;
            }
            .popup-content p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Coufal Family Historical Addresses</h1>
    </div>
    
    <div id="map"></div>

    <!-- Main script for map logic -->
    <script>
        // Family address data
        const familyAddresses = [
            {
                name: "Eli Krotman - Townsend Harris High School (1935)",
                address: "https://maps.app.goo.gl/EPfWPdYHxf32pwth9",
                displayAddress: "17 Lexington Avenue, New York, NY 10010",
                year: 1935,
                family: "Krotman",
                details: "Eli Krotman attended Townsend Harris High School, which was located in the 23rd Street Building of City College (now part of Baruch College). The school was known for its rigorous academics and produced many distinguished alumni.",
                image: "townsend_harris_hs_eli_krotman.jpg",
                link: "https://blogs.baruch.cuny.edu/baruchcollegearchives/?p=282"
            },
            // ... [keep all your existing address entries] ...
        ];

        const familyColors = {
            'Coufal': '#e74c3c',
            'Beasley': '#3498db',
            'Krotman': '#2ecc71',
            'Reckler': '#f1c40f',
            'McKee': '#9b59b6'
        };

        let map;
        let markers = [];
        let currentInfoWindow = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 40.7128, lng: -74.0060 },
                zoom: 11,
                gestureHandling: 'greedy',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            createLegend();
            createMarkers();
        }

        function createLegend() {
            const legendDiv = document.createElement('div');
            legendDiv.className = 'legend';
            
            let legendHTML = '<h3>Family Locations</h3>';
            
            // Create toggle buttons for each family
            Object.keys(familyColors).forEach(family => {
                legendHTML += `
                    <button class="family-toggle-button active" data-family="${family}" 
                            style="background-color: ${familyColors[family]};">
                        <span>${family}</span>
                        <span class="toggle-icon">✓</span>
                    </button>`;
            });

            // Add control buttons
            legendHTML += '<div class="control-buttons">';
            legendHTML += '<button id="show-all-families" class="action-button">Show All</button>';
            legendHTML += '<button id="hide-all-families" class="action-button">Hide All</button>';
            legendHTML += '</div>';

            legendDiv.innerHTML = legendHTML;
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendDiv);

            // Wait for the next frame to ensure elements are in the DOM
            requestAnimationFrame(() => {
                // Add click handlers for family toggle buttons
                const buttons = document.querySelectorAll('.family-toggle-button');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        const family = button.dataset.family;
                        const isActive = button.classList.toggle('active');
                        const icon = button.querySelector('.toggle-icon');
                        icon.textContent = isActive ? '✓' : '×';
                        updateMarkersVisibility();
                    });
                });

                // Add click handler for "Show All" button
                const showAllBtn = document.getElementById('show-all-families');
                if (showAllBtn) {
                    showAllBtn.addEventListener('click', () => {
                        document.querySelectorAll('.family-toggle-button').forEach(button => {
                            button.classList.add('active');
                            button.querySelector('.toggle-icon').textContent = '✓';
                        });
                        updateMarkersVisibility(true);
                    });
                }

                // Add click handler for "Hide All" button
                const hideAllBtn = document.getElementById('hide-all-families');
                if (hideAllBtn) {
                    hideAllBtn.addEventListener('click', () => {
                        document.querySelectorAll('.family-toggle-button').forEach(button => {
                            button.classList.remove('active');
                            button.querySelector('.toggle-icon').textContent = '×';
                        });
                        updateMarkersVisibility(false);
                    });
                }
            });
        }

        function updateMarkersVisibility(showAll = null) {
            const familyButtonStates = {};
            if (showAll === null) {
                document.querySelectorAll('.family-toggle-button').forEach(button => {
                    familyButtonStates[button.dataset.family] = button.classList.contains('active');
                });
            }

            markers.forEach(markerData => {
                let isVisible;
                if (showAll === true) {
                    isVisible = true;
                } else if (showAll === false) {
                    isVisible = false;
                } else {
                    isVisible = familyButtonStates[markerData.familyName];
                }
                markerData.marker.setVisible(isVisible);
            });
        }

        function createMarkers() {
            markers = [];
            familyAddresses.forEach(location => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: location.displayAddress || location.address }, (results, status) => {
                    if (status === 'OK') {
                        const marker = new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: location.name,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: familyColors[location.family],
                                fillOpacity: 0.9,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 10
                            }
                        });

                        const mapsUrl = location.address.startsWith('http') ? location.address : 
                            `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.address)}`;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div class="popup-content">
                                    <h3>${location.name}</h3>
                                    <p><strong>Year:</strong> ${location.year}</p>
                                    <p><strong>Address:</strong> ${location.displayAddress || location.address}</p>
                                    <p>${location.details}</p>
                                    ${location.link ? 
                                        `<p><a href="${location.link}" target="_blank" style="color: #2980b9;">Read more about this location</a></p>`
                                        : ''}
                                    ${location.images ? 
                                        location.images.map(img => 
                                            `<img src="images/${img}" style="width: 100%; margin: 10px 0; border-radius: 4px;">`
                                        ).join('') 
                                        : location.image ? 
                                            `<img src="images/${location.image}" style="width: 100%; margin: 10px 0; border-radius: 4px;">` 
                                            : ''}
                                    <a href="${mapsUrl}" class="action-button" target="_blank">
                                        See Current Day View on Google Maps
                                    </a>
                                </div>
                            `
                        });

                        marker.addListener('click', () => {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            infoWindow.open(map, marker);
                            currentInfoWindow = infoWindow;
                        });
                        
                        markers.push({ marker: marker, familyName: location.family });
                        
                    } else {
                        console.error('Geocode was not successful for the following reason: ' + status + ' for address: ' + (location.displayAddress || location.address));
                    }
                });
            });
            
            setTimeout(() => {
                updateMarkersVisibility(true);
            }, 1000);

            map.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
            });
        }

        // Dynamically load the Google Maps API
        (function() {
            if (typeof GOOGLE_MAPS_API_KEY === 'undefined') {
                console.error("Google Maps API Key not found. Make sure config.js is loaded and contains GOOGLE_MAPS_API_KEY.");
                alert("Error: Google Maps API Key is missing. The map cannot be loaded.");
                return;
            }
            var script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=marker&v=beta`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>