<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coufal Family Historical Addresses</title>
    <!-- config.js will be loaded first -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        #map {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            min-height: 500px;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
            max-width: 180px; 
        }

        .legend h3 {
            margin-bottom: 8px;
            font-size: 14px;
            text-align: center;
        }

        .family-toggle-button {
            border: 1px solid #333;
            margin: 3px 2px;
            padding: 6px 8px;
            border-radius: 3px;
            cursor: pointer;
            width: calc(100% - 4px); 
            font-size: 11px;
            transition: opacity 0.2s;
        }
        
        .family-toggle-button.active {
            opacity: 1;
        }

        .family-toggle-button:not(.active) {
            opacity: 0.6;
        }

        .legend .action-button { 
            background-color: #5e6c7a; 
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block; 
            font-size: 12px;
            text-align: center;
            width: calc(50% - 5px); 
        }
        
        .legend .action-button:hover {
            background-color: #4a545e;
        }

        .popup-content {
            padding: 5px;
            max-width: 250px;
        }

        .popup-content h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .popup-content p {
            font-size: 14px;
            margin: 5px 0;
        }

        .popup-content .action-button { 
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            transition: background-color 0.2s;
            text-decoration: none;
            display: block; 
            font-size: 14px;
            text-align: center;
            width: 100%;
        }
        .popup-content .action-button:hover {
             background-color: #34495e;
        }

        @media (max-width: 600px) {
            .legend {
                bottom: 10px;
                right: 10px;
                padding: 8px;
                font-size: 11px;
                max-width: 140px;
            }
             .family-toggle-button {
                font-size: 10px;
                padding: 5px 6px;
            }
            .legend .action-button {
                font-size: 11px;
                padding: 7px 8px;
            }
            .popup-content {
                max-width: 200px;
            }
            .popup-content h3 {
                font-size: 14px;
            }
            .popup-content p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Coufal Family Historical Addresses</h1>
    </div>
    
    <div id="map"></div>

    <!-- Main script for map logic -->
    <script>
        // Family address data
        const familyAddresses = [
            {
                name: "Eli & Claire Krotman Home (1950)",
                address: "2962 Decatur Avenue, Bronx, New York, NY",
                year: 1950,
                family: "Krotman",
                details: "Eli (age 33) and Claire (age 25)",
                images: ["2962_decatur_ave_bronx._1950_eli_33_claire_25..png", "2962_decatur.png", "2962_decatur_2.png"]
            },
            {
                name: "Claire Reckler High School (1942)",
                address: "500 E Fordham Road, Bronx, New York, NY",
                year: 1942,
                family: "Reckler",
                details: "Claire Reckler attended Theodore Roosevelt High School",
                image: "claire_reckler_1942_high_school_yearbook,_theodore_roosevelt_high_school_500_E_Fordham_Rd,_Bronx,_NY.png"
            },
            {
                name: "Harry Reckler Childhood Home (1910)",
                address: "87 Clinton Street, Manhattan, New York, NY",
                year: 1910,
                family: "Reckler",
                details: "Harry (Hersch) (age 13) lived here with his brother Sam (Salomon) (age 7), sister Rosa (age 16), and mother Chaje (age 42)",
                image: "87_clinton_st_manhattan._1910_harry_reckler_age_13,_sam_7._rosa_16_mother_chaje_42_.png"
            },
            {
                name: "Fannie Hermann Home (1910)",
                address: "288 East 2nd Street, Manhattan, New York, NY",
                year: 1910,
                family: "Krotman",
                details: "Fannie (age 23)",
                image: "288_e_2nd_st_manhattan_fannie_1910_age_23.png"
            },
            {
                name: "Fannie Hermann Family Home (1905)",
                address: "216 East 3rd Street, Manhattan, New York, NY",
                year: 1905,
                family: "Krotman",
                details: "Fannie Hermann (age 17) lived here with her father Joseph (Romanian fruit vendor), brother Tony (decorator), brother Louis (clothing dealer), and sister Regina (millinery)",
                image: "216_e_3rd_st_manhattan._1905_fannie_hermann_age_17._father_joseph_romanian_fruit_vendor._brother_tony_decorator_brother_louis_clothing_dealer_sister_regina_millinery.png"
            },
            {
                name: "Walter Beasley Family Home (1910-1920)",
                address: "406 East 79th Street, Manhattan, New York, NY",
                year: 1910,
                family: "Beasley",
                details: "Walter Beasley (age 14-24) lived here with parents Robert (horse dealer) and Elizabeth from 1910-1920",
                image: "406_e_79_1910-1920_walter_beasley_age_14-24._parents_robert_(horse_dealer)_and_elizabeth.png"
            },
            {
                name: "Sebastian & Antoinette Coufal Home (1910)",
                address: "110-112 East 3rd Street, Manhattan, New York, NY",
                year: 1910,
                family: "Coufal",
                details: "Sebastian worked as a Real Estate Agent",
                image: "503_e_73rd_frank_childhood_home_1910s.png"
            },
            {
                name: "Frank & Anna Coufal Home (1920)",
                address: "534 East 5th Street, Manhattan, New York, NY",
                year: 1920,
                family: "Coufal",
                details: "Frank worked as a plumber",
                image: "534_East_5_Street_frank_anna.png"
            },
            {
                name: "Frank & Anna Coufal Home (1930)",
                address: "87-14 87th Street, Queens, New York, NY",
                year: 1930,
                family: "Coufal",
                details: "Frank worked as a plumber in the building industry",
                image: "87-14_87th_St_queens_coufal_1940.png"
            },
            {
                name: "Walter & Emma Beasley Family Home (1930)",
                address: "115-57 217 Street, Queens, New York, NY",
                year: 1930,
                family: "Beasley",
                details: "Walter & Emma's home where their daughter Edna grew up",
                image: "115_57_217_Street.png"
            },
            {
                name: "Robert & Elizabeth Beasley Home (1910)",
                address: "214 East 10th Street, Manhattan, New York, NY",
                year: 1910,
                family: "Beasley",
                details: "Robert worked as a Horse Dealer",
                image: "214_East_10_Street_beasley_horse_dealer_not_house.png"
            },
            {
                name: "Joseph & Fannie Krotman Home (1920)",
                address: "1524 Washington Avenue, Bronx, New York, NY",
                year: 1920,
                family: "Krotman",
                details: "Joseph (age 32), Fannie (age 31), and Eli (age 3). Joseph worked as a furniture salesman",
                image: "1524_washington_ave_1920_joseph_krotman_32,_fannie_krotman_31,_eli_3.png"
            },
            {
                name: "Joseph & Rose Krotman Home (1930)",
                address: "3604 Olinville Avenue, Bronx, New York, NY",
                year: 1930,
                family: "Krotman",
                details: "Joseph (age 40), Rose (age 32), and Eli (age 12)",
                image: "3604_Olinville_Avenue_1930_joseph_krotman_age_40,_rose_32,_eli_12.png"
            },
            {
                name: "Joseph & Rose Krotman Home (1940)",
                address: "1851 Andrews Avenue, Bronx, New York, NY",
                year: 1940,
                family: "Krotman",
                details: "Joseph worked as a furniture salesman"
            },
            {
                name: "Harry & Anna Reckler Bakery (1930)",
                address: "7420 Fort Hamilton Parkway, Brooklyn, New York, NY",
                year: 1930,
                family: "Reckler",
                details: "Harry and Anna owned and operated their bakery at this location",
                image: "recklerbrooklynbakery_ft_hamilton.png"
            },
            {
                name: "Harry & Anna Reckler Home (1940)",
                address: "2145 Garden Street, Bronx, New York, NY",
                year: 1940,
                family: "Reckler",
                details: "Harry and Anna's residence. Claire lived here when she was 15 years old",
                image: "2145_garden_st.png"
            },
            {
                name: "Harry & Anna Reckler Bakery (1940s)",
                address: "765 East 182 Street, Bronx, New York, NY",
                year: 1940,
                family: "Reckler",
                details: "Harry and Anna owned and operated their bakery at this location in the 1940s",
                image: "765_East_182_Street_reckler_bakery_1940s.png"
            },
            {
                name: "Harry & Anna Reckler Bakery (1950)",
                address: "144-12 Hissons Boulevard, Queens, New York, NY",
                year: 1950,
                family: "Reckler",
                details: "Harry and Anna owned and operated their bakery at this location",
                image: "144-12_hissons_blvd_queens_reckler_bakery.png"
            },
            {
                name: "Walter & Emma Beasley Home (1950)",
                address: "1 South Gate, Massapequa, New York, NY",
                year: 1950,
                family: "Beasley",
                details: "Walter and Emma Beasley's home",
                image: "1_s_gate_massapequa_new_york._walter_and_emma_beasley.png"
            },
            {
                name: "Walter & Emma Beasley Home (1940)",
                address: "Queens, New York, NY",
                year: 1940,
                family: "Beasley",
                details: "Walter Beasley's residence",
                image: "walter_beasley_queens.png"
            },
            {
                name: "Edward & Annie McKee Home (1910)",
                address: "335 East 93 Street, Manhattan, New York, NY",
                year: 1910,
                family: "McKee",
                details: "Edward McKee's house, where Emma Beasley lived at age 20",
                image: "335_East_93_Street_emma_beasley_20_yrs_old._edward_mckee_father_house.png"
            },
            {
                name: "Walter & Emma Beasley Home (1950)",
                address: "88-14 168th Street, Queens, New York, NY",
                year: 1950,
                family: "Beasley",
                details: "Walter worked as a supervisor at the Telephone Company",
                image: "88_14_168_Street.png"
            },
            {
                name: "Frank & Anna Coufal Home (1950)",
                address: "219-27 114 Avenue, Queens, New York, NY",
                year: 1950,
                family: "Coufal",
                details: "Lived here with their sons Donald (22) and Frank Jr. (25)",
                image: "coufal1940.png"
            },
            {
                name: "Eli Krotman - Townsend Harris High School (1935)",
                address: "https://maps.app.goo.gl/EPfWPdYHxf32pwth9",
                displayAddress: "17 Lexington Avenue, New York, NY 10010",
                year: 1935,
                family: "Krotman",
                details: "Eli Krotman attended Townsend Harris High School, which was located in the 23rd Street Building of City College (now part of Baruch College). The school was known for its rigorous academics and produced many distinguished alumni.",
                image: "townsend_harris_hs_eli_krotman.jpg",
                link: "https://blogs.baruch.cuny.edu/baruchcollegearchives/?p=282"
            }
                year: 1935,
                family: "Krotman",
                details: "Eli Krotman attended Townsend Harris High School, which was located in the 23rd Street Building of City College (now part of Baruch College). The school was known for its rigorous academics and produced many distinguished alumni.",
                image: "townsend_harris_hs_eli_krotman.jpg",
                link: "https://blogs.baruch.cuny.edu/baruchcollegearchives/?p=282"
            },
            {
                name: "Eli & Claire Krotman",
                address: "2962 Decatur Avenue, Bronx, New York, NY",
                year: 1950,
                family: "Krotman",
                details: "Eli (age 33) and Claire (age 25)",
                images: ["2962_decatur_ave_bronx._1950_eli_33_claire_25..png", "2962_decatur.png", "2962_decatur_2.png"]
            },
            {
                name: "Claire Reckler",
                address: "500 E Fordham Road, Bronx, New York, NY",
                year: 1942,
                family: "Reckler",
                details: "Claire Reckler's high school - Theodore Roosevelt High School",
                image: "claire_reckler_1942_high_school_yearbook,_theodore_roosevelt_high_school_500_E_Fordham_Rd,_Bronx,_NY.png"
            },
            {
                name: "Harry Reckler Family",
                address: "87 Clinton Street, Manhattan, New York, NY",
                year: 1910,
                family: "Reckler",
                details: "Harry (Hersch) (age 13), Sam (Salomon) (age 7), Rosa (age 16), and mother Chaje (age 42)",
                image: "87_clinton_st_manhattan._1910_harry_reckler_age_13,_sam_7._rosa_16_mother_chaje_42_.png"
            },
            {
                name: "Fannie Hermann",
                address: "288 East 2nd Street, Manhattan, New York, NY",
                year: 1910,
                family: "Krotman",
                details: "Fannie (age 23)",
                image: "288_e_2nd_st_manhattan_fannie_1910_age_23.png"
            },
            {
                name: "Fannie Hermann Family",
                address: "216 East 3rd Street, Manhattan, New York, NY",
                year: 1905,
                family: "Krotman",
                details: "Fannie Hermann (age 17), father Joseph (Romanian fruit vendor), brother Tony (decorator), brother Louis (clothing dealer), sister Regina (millinery)",
                image: "216_e_3rd_st_manhattan._1905_fannie_hermann_age_17._father_joseph_romanian_fruit_vendor._brother_tony_decorator_brother_louis_clothing_dealer_sister_regina_millinery.png"
            },
            {
                name: "Walter Beasley",
                address: "406 East 79th Street, Manhattan, New York, NY",
                year: 1910,
                family: "Beasley",
                details: "Walter Beasley (age 14-24), with parents Robert (horse dealer) and Elizabeth. Lived here 1910-1920",
                image: "406_e_79_1910-1920_walter_beasley_age_14-24._parents_robert_(horse_dealer)_and_elizabeth.png"
            },
            {
                name: "Sebastian & Antoinette Coufal",
                address: "110-112 East 3rd Street, Manhattan, New York, NY",
                year: 1910,
                family: "Coufal",
                details: "Sebastian worked as a Real Estate Agent",
                image: "503_e_73rd_frank_childhood_home_1910s.png"
            },
            {
                name: "Frank & Anna Coufal",
                address: "534 East 5th Street, Manhattan, New York, NY",
                year: 1920,
                family: "Coufal",
                details: "Frank worked as a plumber",
                image: "534_East_5_Street_frank_anna.png"
            },
            {
                name: "Frank & Anna Coufal",
                address: "87-14 87th Street, Queens, New York, NY",
                year: 1930,
                family: "Coufal",
                details: "Frank worked as a plumber in the building industry",
                image: "87-14_87th_St_queens_coufal_1940.png"
            },
            {
                name: "Walter & Emma Beasley",
                address: "115-57 217 Street, Queens, New York, NY",
                year: 1930,
                family: "Beasley",
                details: "Walter & Emma's home where their daughter Edna grew up",
                image: "115_57_217_Street.png"
            },
            {
                name: "Robert & Elizabeth Beasley",
                address: "214 East 10th Street, Manhattan, New York, NY",
                year: 1910,
                family: "Beasley",
                details: "Robert worked as a Horse Dealer",
                image: "214_East_10_Street_beasley_horse_dealer_not_house.png"
            },
            {
                name: "Joseph & Fannie Krotman",
                address: "1524 Washington Avenue, Bronx, New York, NY",
                year: 1920,
                family: "Krotman",
                details: "Joseph worked as a furniture salesman"
            },
            {
                name: "Joseph & Rose Krotman",
                address: "3604 Olinville Avenue, Bronx, New York, NY",
                year: 1930,
                family: "Krotman",
                details: "Joseph (age 40), Rose (age 32), and Eli (age 12)",
                image: "3604_Olinville_Avenue_1930_joseph_krotman_age_40,_rose_32,_eli_12.png"
            },
            {
                name: "Joseph & Rose Krotman",
                address: "1851 Andrews Avenue, Bronx, New York, NY",
                year: 1940,
                family: "Krotman",
                details: "Joseph worked as a furniture salesman"
            },
            {
                name: "Harry & Anna Reckler",
                address: "7420 Fort Hamilton Parkway, Brooklyn, New York, NY",
                year: 1930,
                family: "Reckler",
                details: "Harry worked as a baker",
                image: "recklerbrooklynbakery_ft_hamilton.png"
            },
            {
                name: "Harry & Anna Reckler",
                address: "2145 Garden Street, Bronx, New York, NY",
                year: 1940,
                family: "Reckler",
                details: "Harry worked as a storekeeper"
            },
            {
                name: "Harry & Anna Reckler",
                address: "144-12 Hissons Boulevard, Queens, New York, NY",
                year: 1950,
                family: "Reckler",
                details: "Harry owned and operated a bakery",
                image: "144-12_hissons_blvd_queens_reckler_bakery.png"
            },
            {
                name: "Walter & Emma Beasley",
                address: "1 South Gate, Massapequa, New York, NY",
                year: 1950,
                family: "Beasley",
                details: "Walter and Emma Beasley's home",
                image: "1_s_gate_massapequa_new_york._walter_and_emma_beasley.png"
            },
            {
                name: "Walter & Emma Beasley",
                address: "Queens, New York, NY",
                year: 1940,
                family: "Beasley",
                details: "Walter Beasley's residence",
                image: "walter_beasley_queens.png"
            },
            {
                name: "Harry & Anna Reckler",
                address: "765 East 182 Street, Bronx, New York, NY",
                year: 1940,
                family: "Reckler",
                details: "Reckler Bakery location in the 1940s",
                image: "765_East_182_Street_reckler_bakery_1940s.png"
            },
            {
                name: "Harry & Anna Reckler",
                address: "2145 Garden Street, Bronx, New York, NY",
                year: 1940,
                family: "Reckler",
                details: "Reckler family residence. Claire lived here when she was 15 years old",
                image: "2145_garden_st.png"
            },
            {
                name: "Joseph & Fannie Krotman",
                address: "1524 Washington Avenue, Bronx, New York, NY",
                year: 1920,
                family: "Krotman",
                details: "Joseph (age 32), Fannie (age 31), and Eli (age 3)",
                image: "1524_washington_ave_1920_joseph_krotman_32,_fannie_krotman_31,_eli_3.png"
            },
            {
                name: "Edward & Annie McKee",
                address: "335 East 93 Street, Manhattan, New York, NY",
                year: 1910,
                family: "McKee",
                details: "Edward McKee's house, where Emma Beasley lived at age 20",
                image: "335_East_93_Street_emma_beasley_20_yrs_old._edward_mckee_father_house.png"
            },
            {
                name: "Walter & Emma Beasley",
                address: "88-14 168th Street, Queens, New York, NY",
                year: 1950,
                family: "Beasley",
                details: "Walter worked as a supervisor at the Telephone Company",
                image: "88_14_168_Street.png"
            },
            {
                name: "Frank & Anna Coufal",
                address: "219-27 114 Avenue, Queens, New York, NY",
                year: 1950,
                family: "Coufal",
                details: "Lived here with their sons Donald (22) and Frank Jr. (25)",
                image: "coufal1940.png"
            }
        ];

        const familyColors = {
            'Coufal': '#e74c3c',
            'Beasley': '#3498db',
            'Krotman': '#2ecc71',
            'Reckler': '#f1c40f',
            'McKee': '#9b59b6'
        };

        let map;
        let markers = [];
        let currentInfoWindow = null;

        // initMap is now called by the Google Maps API script load (callback=initMap)
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 40.7128, lng: -74.0060 },
                zoom: 11,
                gestureHandling: 'greedy',
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            createLegend();
            createMarkers(); 
        }

        function createLegend() {
            const legendDiv = document.createElement('div');
            legendDiv.className = 'legend';
            
            let legendHTML = '<h3>Families</h3>';
            Object.keys(familyColors).forEach(family => {
                legendHTML += `<button class="family-toggle-button active" data-family="${family}" style="background-color: ${familyColors[family]}; color: white;">Hide ${family}</button>`;
            });
            legendHTML += '<div style="margin-top: 10px; display: flex; justify-content: space-between;">';
            legendHTML += '<button id="show-all-families" class="action-button">Show All</button>';
            legendHTML += '<button id="hide-all-families" class="action-button">Hide All</button>';
            legendHTML += '</div>';

            legendDiv.innerHTML = legendHTML;
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendDiv);

            document.querySelectorAll('.family-toggle-button').forEach(button => {
                button.addEventListener('click', () => {
                    const family = button.dataset.family;
                    const isActive = button.classList.toggle('active');
                    button.textContent = isActive ? `Hide ${family}` : `Show ${family}`;
                    button.style.opacity = isActive ? '1' : '0.6';
                    updateMarkersVisibility();
                });
            });

            document.getElementById('show-all-families').addEventListener('click', () => {
                document.querySelectorAll('.family-toggle-button').forEach(button => {
                    if (!button.classList.contains('active')) {
                        button.classList.add('active');
                        button.textContent = `Hide ${button.dataset.family}`;
                        button.style.opacity = '1';
                    }
                });
                updateMarkersVisibility(true);
            });

            document.getElementById('hide-all-families').addEventListener('click', () => {
                document.querySelectorAll('.family-toggle-button').forEach(button => {
                    if (button.classList.contains('active')) {
                        button.classList.remove('active');
                        button.textContent = `Show ${button.dataset.family}`;
                        button.style.opacity = '0.6';
                    }
                });
                updateMarkersVisibility(false);
            });
        }

        function updateMarkersVisibility(showAll = null) {
            const familyButtonStates = {};
            if (showAll === null) {
                document.querySelectorAll('.family-toggle-button').forEach(button => {
                    familyButtonStates[button.dataset.family] = button.classList.contains('active');
                });
            }

            markers.forEach(markerData => {
                let isVisible;
                if (showAll === true) {
                    isVisible = true;
                } else if (showAll === false) {
                    isVisible = false;
                } else {
                    isVisible = familyButtonStates[markerData.familyName];
                }
                markerData.marker.setVisible(isVisible);
            });
        }

        function createMarkers() {
            markers = [];
            familyAddresses.forEach(location => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: location.displayAddress || location.address }, (results, status) => {
                    if (status === 'OK') {
                        const marker = new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: location.name,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: familyColors[location.family],
                                fillOpacity: 0.9,
                                strokeWeight: 2,
                                strokeColor: '#ffffff',
                                scale: 10
                            }
                        });

                        const mapsUrl = location.address.startsWith('http') ? location.address : 
                            `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.address)}`;
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div class="popup-content">
                                    <h3>${location.name}</h3>
                                    <p><strong>Year:</strong> ${location.year}</p>
                                    <p><strong>Address:</strong> ${location.displayAddress || location.address}</p>
                                    <p>${location.details}</p>
                                    ${location.link ? 
                                        `<p><a href="${location.link}" target="_blank" style="color: #2980b9;">Read more about this location</a></p>`
                                        : ''}
                                    ${location.images ? 
                                        location.images.map(img => 
                                            `<img src="${img}" style="width: 100%; margin: 10px 0; border-radius: 4px;">`
                                        ).join('') 
                                        : location.image ? 
                                            `<img src="${location.image}" style="width: 100%; margin: 10px 0; border-radius: 4px;">` 
                                            : ''}
                                    <a href="${mapsUrl}" class="action-button" target="_blank">
                                        See Current Day View on Google Maps
                                    </a>
                                </div>
                            `
                        });

                        marker.addListener('click', () => {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            infoWindow.open(map, marker);
                            currentInfoWindow = infoWindow;
                        });
                        
                        markers.push({ marker: marker, familyName: location.family });
                        
                    } else {
                        console.error('Geocode was not successful for the following reason: ' + status + ' for address: ' + (location.displayAddress || location.address));
                    }
                });
            });
            
            setTimeout(() => {
                 updateMarkersVisibility(true);
            }, 1000);

            map.addListener('click', () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
            });
        }

        // Dynamically load the Google Maps API
        // This assumes GOOGLE_MAPS_API_KEY is defined in config.js
        (function() {
            if (typeof GOOGLE_MAPS_API_KEY === 'undefined') {
                console.error("Google Maps API Key not found. Make sure config.js is loaded and contains GOOGLE_MAPS_API_KEY.");
                alert("Error: Google Maps API Key is missing. The map cannot be loaded.");
                return;
            }
            var script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=marker&v=beta`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        })();

    </script>
</body>
</html>